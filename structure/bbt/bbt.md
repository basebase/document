#### 平衡二叉树(Balanced Binary Tree)


##### 什么是平衡二叉树?

###### 平衡二叉树的基本概念

在介绍平衡二叉树之前, 我们先来回忆一下二分搜索树的一个问题。
假设有一组数[1, 2, 3, 4, 5, 6]如果我们以顺序添加到二分搜索树中, 那么这颗二分搜索树就会退化成一个链表(如图[1-1]展示)。这就大大降低二分搜索树的效率。那么怎么解决这个问题呢? 我们需要在现有的二分搜索树的基础上添加一定的机制, 使得我们的二分搜索树能够维持平衡二叉树。

[图1-1 [退化成链表的二分搜索树]]
![1-1](https://github.com/basebase/img_server/blob/master/common/bbt01.png?raw=true)


那么平衡二叉树是什么? 在我们之前的树结构中有遇到过平衡二叉树吗?


1. 一颗满二叉树一定是一颗平衡二叉树。

2. 完全二叉树(堆)。对于完全二叉树来说, 空缺的节点部分一定是在树的右下部分, 相应的对于一颗完全二叉树整棵树的叶子节点最大的深度值和最小的深度值相差不会超过1。也就是说我们所有的叶子节点要么在最后一层, 要么在倒数第二次。

3. 线段树也就是一种平衡二叉树。虽然线段树不是一个完全二叉树, 对于线段树来说空出来的部分不一定在整个树的右下角的位置, 但是在一个整体线段树中叶子节点也是在最后一层或者在倒数第二层。对于整棵树来说我们叶子节点的深度相差不会超过1。

以上这些都是平衡二叉树的例子。


平衡二叉树的定义:
+ <strong>对于任意一个节点, 左子树和右子树的高度差不能超过1。</strong>

上面的定义看着和我们的之前的完全二叉树还是线段树这样的二叉树都差不多, 但实际上是有区别的。对于堆和线段树来说, 可以保证任意一个叶子节点相应的高度差都不超过1。而上面的定义是任意一个节点左右子树高度差不超过1。在这个定义下我们得到的平衡二叉树有可能看着不是"那么的"平衡(如图[1-2])。

[图1-2 [一颗平衡二叉树]]
![1-2](https://github.com/basebase/img_server/blob/master/common/bbt02.png?raw=true)

该图中的结构, 显然是不会出现在堆或者线段树这两种树结构中。这棵树看起来稍微有一些偏斜, 但如果仔细去验证每一个节点就会发现, 这棵树是满足平衡二叉树的定义的。

```text
从根节点12开始, 左子树高度是3, 右子树高度是2。高度差为1。没有超过1。
节点8开始, 左子树高度是2, 右子树高度1。高度差为1。没有超过1。
节点18开始, 左子树高度是1, 右子树高度0。高度差为1。没有超过1。
节点5开始, 左子树高度是1, 右子树高度0。高度差为1。没有超过1。

相应的11, 17, 4。这三个节点是叶子节点, 对于叶子节点来说左右子树都是空, 说明左右子树高度都为0, 所以差为0, 也没有超过1。

所以, 这颗树看起来有些偏斜, 但是, 是在我们这个定义下的一颗平衡二叉树。
```

图[1-2]已经是一颗平衡二叉树了, 但是如果我们在这棵树上添加节点的话, 比如添加一个节点2和节点7, 根据二分搜索树的性质, 那么节点2会从根节点一路找下来, 最终添加到节点4左子树中, 相应的如果在添加一个节点7, 节点7会添加到节点5右子树中。就会形成图[1-3]的样子。但是已经不在是一颗平衡二叉树了。

[图1-3 [一颗失去平衡的二叉树]]
![1-3](https://github.com/basebase/img_server/blob/master/common/bbt03.png?raw=true)

可以看到节点8的位置上, 左子树的高度是3, 右子树的高度是1。左右子树的高度差为2。破坏了平衡二叉树的条件。同理根节点12也是一样, 他的左子树高度是4, 右子树高度是2。高度差为2。所以, 现在这棵二叉树不在是一颗平衡二叉树了。

那么如何保持平衡呢? 我们必须保证在插入节点的时候, 相应的也要顾及这颗树的右侧部分。
因为这棵树现在看是向左偏斜的。相应的也要填补这棵树右侧空间的节点。才能继续让这颗树维持平衡二叉树左右子树高度差不超过1这个性质。


在具体开发中, 由于要跟踪每一个节点对应的高度是多少, 只有这样才方便我们判断, 当前的二叉树是否是平衡的。所以对之前实现的二分搜索树来说, 要实现平衡二叉树我们只要对每一个节点标注节点高度。这个记录非常的简单。

```text
标注节点高度过程:

对于叶子节点2高度为1, 4这个节点由于有叶子节点2对应的高度为2, 对于叶子节点7高度为1。

对于5这个节点, 由于有左右两颗子树, 左边的子树高度为2, 右边的子树高度为1, 相应的节点5的高度就是左右两颗子树中最高的那棵树在加上1。这个1是节点5自身。所以节点5的高度是3。

叶子节点11的高度为1, 节点8的高度4, 叶子节点17的高度为1。
节点18的高度为2。根节点的高度为5。

这样, 我们就对每一个节点都标注好了高度值。
```

上面, 我们把节点高度值标注好之后, 相应的我们要计算一个"平衡因子"。
平衡因子: 就是计算左右子树的高度差。计算方法就是[左子树高度-右子树高度]。


```text
平衡因子计算过程:

对于叶子节点2, 它的左右两颗子树相当于是两颗空树, 空树的高度记为0, 相应的叶子节点的平衡因子就是(0 - 0)结果为0。

对于节点4来说左子树高度为1, 右子树为高度0, 即平衡因子为(1 - 0)为1
叶子节点7的平衡因子也为0

节点5的左子树高度为2, 右子树高度为1, 即平衡因子为(2 - 1)为1
叶子节点11的平衡因子也为0

节点8的左子树高度为3, 右子树高度为1, 即平衡因子为(3 - 1)为2, 这就意味着对于8这个节点来说, 左右子树高度差超过1了, 通过这个平衡因子就能看出这棵树已经不是一颗平衡二叉树了。换句话说, 只要平衡因此大于1, 这棵树就不是一颗平衡二叉树了。

叶子节点17的平衡因子也为0
对于节点18来说左子树高度为1, 右子树高度为0, 即平衡因子为(1 - 0)为1

对于根节点12, 左子树高度为4, 右子树高度为2, 即平衡因子为(4 - 2)为2
```

经过上面平衡因子的计算, 我们很清楚的知道有两个节点破坏了平衡二叉树的性质。


[图1-4 [计算二叉树的高度和平衡因子]]
![1-4](https://github.com/basebase/img_server/blob/master/common/bbt04.png?raw=true)
