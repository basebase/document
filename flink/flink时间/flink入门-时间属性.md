### flink入门-时间属性

#### 时间概念
本小结介绍流式场景中时间语义和不同的时间概念。讨论流处理引擎如何基于乱序事件也能产生精确结果。

##### 流处理场景下一分钟的含义
当处理一个持续达到且可能无穷的事件流时, 时间变成了应用中最核心的要素。假设现在要持续计算结果, 比如每分钟计算一次, 那么***一分钟***在流式应用环境中的含义到底是什么?

现在有个手游厂商需要对玩家进行分析, 比如玩家一分钟内消灭100块砖头就提升一级, 小A是该款游戏的铁杆玩家, 每天早晨上班在地铁上都会玩, 但是有一个问题, 就是当地铁开进一条隧道手机就会断网, 此时数据无法发送出去, 小A继续进行游戏该过程产生的事件数据缓存在手机, 离开隧道后, 重新连上网络, 将此前缓存的事件数据发送给应用。

此时应用如何处理? 上述示例中一分钟的含义又是什么? 需要把小A离线的时间考虑在内吗？

参考下图
![时间例子](https://github.com/basebase/document/blob/master/flink/image/flink%E6%97%B6%E9%97%B4/%E6%97%B6%E9%97%B4%E4%BE%8B%E5%AD%90.png?raw=true)
当地铁进入隧道断网时, 应用接收事件会中断一会, 此时时间会缓存在玩家手机中, 并在网络恢复后发送

通过在线手游这个简单场景展示了算子的语义应该依赖事件实际发生的时间而非应用收到的时间。
如果应用按照收到时间计算后果可能非常糟糕, 玩家不愿意在继续, 如果仅考虑一分钟内收到多少数据, 那么结果可能会随着网络连接速度或处理速度进而改变, 然而事实上每分钟收到事件数目是由数据本身的时间来定义的。

所以在该例子中, 流式应用可以使用两个不同概念的时间, 处理时间(processing time)和事件时间(event time)


##### 处理时间
处理时间是当前流处理算子所在机器上的本地时间, 基于处理时间的窗口会包含那些恰好在一段时间内到达窗口算子的事件, 这里的时间段是按照所在机器时间测量的。如下图, 在小A的例子中, 处理时间窗口在他手机离线后还会继续计时, 因此不会把他离线那段时间的活动考虑在内

![时间例子-处理时间](https://github.com/basebase/document/blob/master/flink/image/flink%E6%97%B6%E9%97%B4/%E6%97%B6%E9%97%B4%E4%BE%8B%E5%AD%90-%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4.png?raw=true)
小A手机离线后继续计时的处理时间窗口


##### 事件时间
事件时间是数据流中事件实际发生的时间, 这些时间戳通常在事件数据进入flink之前就存在, 如下图所示, 即使事件有延迟, 事件时间窗口也能准确的将事件分配到窗口中, 从而反映出真实发生的情况

![时间例子-事件时间](https://github.com/basebase/document/blob/master/flink/image/flink%E6%97%B6%E9%97%B4/%E6%97%B6%E9%97%B4%E4%BE%8B%E5%AD%90-%E4%BA%8B%E4%BB%B6%E6%97%B6%E9%97%B4.png?raw=true)
事件时间准确的将事件分配到窗口中, 从而反映出真实的情况

事件时间将处理速度和结果内容彻底解耦。基于事件时间的操作是可以预测的, 其结果具有确定性。无论数据流的处理速度如何、事件达到算子的顺序怎样, 基于事件时间的窗口都会生成同样的结果

使用时间时间需要克服的挑战之一就是如何处理延迟事件, 依靠事件时间我们可以保证在数据乱序的情况下结果依然正确。

##### 摄入时间
通常还有第3个时间概念, 即摄入时间, 也被称为进入时间。它指的是事件进入流处理框架时间。缺乏真实事件时间的数据都会被流处理器附上时间戳, 即流处理器第一次看到它的时间(这个操作由source函数完成, 它是程序的第一个处理节点)


#### 总结
通常根据程序处理逻辑不通可以选择与之对应的时间语义和属性, 比如一些预警、计算UV等程序, 可能需要快速响应结果可以容忍一些误差, 不需要等待迟到的事件, 因此采用处理时间语义会更加适合, 但是如果涉及到账单财务等则需要对准确性有要求, 只有在时间窗口内发生的事件才被计算, 对于这些程序, 事件时间语义会更适合

#### 参考
[时间属性](https://ci.apache.org/projects/flink/flink-docs-master/zh/docs/dev/table/concepts/time_attributes/)

[基于Apache Flink的流处理(36 ~ 39页)](#)

[Flink基础教程(40 ~ 41页)](#)