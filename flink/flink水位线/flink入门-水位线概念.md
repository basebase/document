### flink入门-水位线概念


#### watermark

##### 生活例子
在介绍watermark概念之前, 先通过一个生活中的例子有个整体的概念。

篮球是大家比较熟悉的一个场景, 如果把篮球比赛看成是一个流处理应用, 那么每场比赛开始时间到结束时间就是一个窗口(window), 每个球员可以理解为一条记录, 球员到达球场的时间可以理解为记录的时间戳, 而球赛过程中的技巧操作等可以理解为某种算子操作。

假设, 球赛开始时间设定为9:30但是大赛考虑到有些球员距离比较远, 推迟10分钟, 即所有球员在9:40之前必须入场, 否则失去资格, 那么9:40可以理解为一个"水位线", 有些球员距离赛场很近提早进场, 假设有一个叫小A的球员因为睡觉迟到了20分钟, 按照比赛规定, 小A是不允许进入赛场的, 因为此时默认所有球员都已经在赛场了, 球赛也开始了, 那么小A可以理解为迟到的事件。

以上就是对窗口、事件以及水位线的简单理解。


##### watermark(水位线)概念

在介绍概念之前, 一定要记住水位线两个基本属性
1. 必须单调递增, 这是为了确保任务中的事件时间时钟正确前进不会倒退
2. 和记录的时间戳存在关联, 一个时间戳为T的水位线表示, 接下来所有记录的时间戳都一定大于T

watermark是通过延迟触发来达到乱序数据的处理, 并不是说使用watermark就能解决数据乱序, 并且flink不仅仅只有watermark这一种延迟机制保证延迟数据。


在时间属性中, 详细介绍了三种时间语义, 并且我们还知道真实数据环境中会存在数据乱序的问题, 我们先看看下面一个例子。

假设现在要每分钟统计过去一小时注册渠道的TopN, 这是一个典型的滑动窗口, 如果基于"事件时间"的窗口在什么时候触发计算? 换句话说, 我需要等多久才能确定已经接收到了特定时间点之前的所有事件, 另一方面, 由于网络等其它原因, 数据还会产生乱序, 在进行窗口操作时, 不能无限期等待, 需要一个机制来告诉窗口在某个特定时间出发窗口计算, 即认为小于等于该时间的数据都到了, 这个机制就是watermark(水位线), ***可以用来处理乱序事件***

水位线是一个全局的进度指标, 表示我们确信不会再有延迟事件到来的某个时间点。

本质上, 水位线提供了一个逻辑时钟, 用来通知系统当前的事件时间。

当一个算子接收到时间为T的水位线, 就可以认为不会再收到任何时间戳小于或者等于T的事件了。

水位线无论对于事件窗口还是处理乱序事件的算子都很关键。

算子一旦收到某个水位线, 就相当于收到信号: 表示某个特定时间区间的时间戳事件都已经到齐, 可以触发窗口计算;


水位线允许我们在结果的准确性和延迟之间做取舍, 比如我们乱序数据不知道到底会延迟多久, 如果延迟设置低了, 处理效率提高了但是随之而来的是数据可信度问题, 延迟数据可能会在水位线之后到来, 但是, 如果水位线设置过于保守, 虽然可信度可以保证, 但可能会增加处理延迟。

很多应用中, 系统无法获取足够多的信息来完美的设置水位线, 以手游为例, 现实中无法得知用于会离线多久。可能正在通过隧道, 可能在飞机上或者干脆不玩了。
无论水位线是由用户自定义还是自动生成, 只要存在"拖后腿"的任务, 全局进度就可能出现问题, 所以简单依赖水位线并不能完美解决数据延迟问题, 还需要通过其它机制来处理晚于水位线的事件数据。

我们可以通过下面这张图可以直观的观察到, 真实环境中要设置的水位线和理想中完美的水位线之间的关系

![flink水位线-1](https://github.com/basebase/document/blob/master/flink/image/flink%E6%B0%B4%E4%BD%8D%E7%BA%BF/flink%E6%B0%B4%E4%BD%8D%E7%BA%BF-1.png?raw=true)

图中浅灰色直虚线表示理想的水位线, 深灰色弯曲虚线表示现实中的水位线, 黑色直线表示两者之间的偏差。理想状态下, 这种偏差为0, 因为总是在时间发生时就会立即处理。即事件的真实时间和处理时间是一致的。

比如: 12:10产生的事件刚好在12:10被处理, 12:11产生的事件刚好在12:11被处理, 但是现实中总会有迟到的数据产生, 所以真实的情况就会像深灰色的弯曲虚线表示的那样, 即: 12:10产生的数据可能在12:10之后被处理, 12:11产生的数据在12:11处理, 12:12产生的数据在12:12之后处理, 这种动态的偏差在分布式处理系统中是非常常见的。