### flink入门-水位线设置规则

#### 水位线延迟及完整性

现在已经通过代码实现如何生成一个watermark, 前面已经介绍过, 水位线可以有效的等待延迟数据, 解决数据乱序问题, 但是实际生产中并不能设置一个完美的水位线, 总是会存在一些漏网之鱼的数据。

在生产环境中, 我们可能要对数据传输以及数据分区等一切信息进行了解, 了解每个分区下数据之间间隔时长, 进行评估进而选取一个比较合理的等待时间。当然既然是评估的时间还是会存在一定的遗漏的数据, 但这部分数据可能仅是非常小的一部分。

如果水位线延迟时间设置过于宽松, 即水位线远远落后于已经处理记录的时间戳, 那么会导致产生结果的延迟(即结果遭就已经生成, 但必须等待水位线来触发)。这样的好处是在执行计算时能确保数据都已经收集完成。

反之, 如果水位线延迟事件设置过于紧迫, 即水位线可能大于部分后来的时间戳, 那么计算可能会在相关数据到齐之前就已经被触发。这样做会导致结果不完整或者不准确, 但相应的可以做到比较低延迟及时生成结果。


所以, 针对评估后的时间如果还存在遗漏数据, 可以通过window allowedLateness和侧输出流来保证数据的完整性。

最后, 对于采用周期分配模式还是定点分配模式, 这里一般都是采用周期性生成WaterMark, 因为定点分配模式会来每来一条事件调用一次, 在实际生产中TPS很高的场景下会产生大量的Watermark在一定程度上对下游算子造成压力。


#### 参考
[Flink-Watermark](https://meihuakaile.github.io/2020/05/11/Flink-Watermark/)


